<?php 
/**
 * Request_Rma extension
 * Rma view template
 *
 * @category	Request
 * @package		Request_Rma
 * @author      Tosif Qureshi
 */

/* Get rma details */ 
$_rma_data = $this->getCurrentRmaData();
/* Get order id */
$_order_id = $this->getOrderId($_rma_data->getRma_id());
/* Get product data */
$_product_data = $this->getProductData($_rma_data->getProduct_id());
/* Get order data */
$_order_data = $this->getOrderDetails($_order_id);
/* Get rma reason records */
$_reason_data = $this->getRmaReasons();
/* Get serial numbers */
$_serial_number = $this->getSerialNumbers($_rma_data->getSerial_number());
/* Get invoice number records of order */
$_invoice_data = Mage::helper('rma/request')->getInvoiceNumbers($_order_id);
/* Get product quantity of order */
$_product_quantity =  Mage::helper('rma/request')->getProductQuantity($_rma_data->getProduct_id());
/* Get invoice number */
$_invoice_number = $this->getInvoiceNumber($_rma_data->getInvoice_number());
/* Get count of serial number */
$_serial_count = $this->getSerialCount($_serial_number);
/* Get all reported RMA of customer */
$_description_collection = $this->getDescriptionData($_rma_data->getItem_id());	
?>

<div class="block block-subscribe">
	<input name="product_quantity" id="product_quantity" value="<?php echo $_description_collection->getSize();?>" type="hidden">
	<input id="remain_count" value="<?php echo $_description_collection->getSize();?>" type="hidden">
	<div class="block-title">
		<strong><span><?php echo $this->getRmaTypeTitle();?></span></strong>
    </div>
	<!-- Rma form to report complaint or return request-->
	<form id="rma_edit_form" name="rma_edit_form" action="<?php echo $this->getUrl('rma/request/');?>editRma" method="post">
		 <div class="block-content">
			<!-- Product name based on sku number --> 
			<div class="form-subscribe-header formLabelTxt">
				<label for="name"><?php echo $this->__('Product Name');?><span></span></label>
			</div>
			<div class="input-box">
				<?php echo $_product_data->getName();?>
			</div>
			<div class="clear"></div>
			
			<!-- Quantity text field of report-->
			<div class="form-subscribe-header formLabelTxt">
				<label for="name"><?php echo $this->__('Quantity');?><span></span></label>
			</div>
			<!-- Product quantity selectbox of rma -->
			<select name="quantity" id="quantity" class="minWidth130">
				<?php
				 for($i=1;$i<=$_product_quantity;$i++) : ?>
					<option value="<?php echo $i;?>" <?php if($i==$_rma_data->getQuantity()) {?> selected="selected"<?php } ?>><?php echo $i;?></option>
				<?php endfor; ?>
			</select>
			<div class="clear"></div>
			
			<!-- Invoice number text field of report-->
			<div class="form-subscribe-header formLabelTxt">
				<label for="name"><?php echo $this->__('Invoice Number');?><span></span></label>
			</div>
			<!-- Invoice number selectbox of rma -->
			<select name="invoice_number">
				<option value=""><?php echo $this->getInvoiceOptLbl(count($_invoice_data));?></option>
				<?php foreach($_invoice_data as $invoice) : ?>
					<option value="<?php echo $invoice['id'];?>" <?php if($_rma_data->getInvoice_number()==$invoice['id']) {?> selected="selected"<?php } ?>><?php echo $invoice['name'];?></option>
				<?php endforeach; ?>
			</select>
			<div class="clear"></div>
			
			<!-- Reason type of RMA -->
			<div class="form-subscribe-header formLabelTxt">
				<label for="name"><?php echo $this->__('Reason');?><span></span></label>
			    <label class="requireTxt"><?php echo $this->__('*') ?></label>
			</div>
			<!-- Reason selectbox of rma -->
			<select name="reason_id" id="reason_id" class="required-entry reasonSelect">
				<option value=""><?php echo $this->__('Select your reason');?></option>
				<?php
				 foreach($_reason_data as $reason) : 
					if($reason->getIs_active()==1) : ?>
						<option value="<?php echo $reason->getId();?>" <?php if($_rma_data->getReason_id()==$reason->getId()) {?> selected="selected"<?php } ?>><?php echo $reason->getReason();?></option>
					<?php
					endif;
				  endforeach; ?>
			</select>
			<div class="clear"></div>
			
			<!-- Reason Description Div start here -->
			
			<?php  
			$i = 1;
			foreach($_description_collection as $_description_collection) :?>
				<div  id="reasonDiv<?php echo $i;?>">
				<div class="fl width108px">
					<!-- Serial number text field of report-->
					<div class="form-subscribe-header formLabelTxt">
						<label for="name"><?php echo $this->__('Serial Number');?><span></span></label>
						<label class="requireTxt"><?php echo $this->__('*') ?></label>
					</div>
					<div class="input-box">
						<div id="serailDiv">
							<div class="serialRow">
								<input name="serial_number[]" id="serial_number" title="Serial Number" value="<?php echo $_description_collection->getSerial_number();?>" type="text" class="required-entry validate-number width108px">
							</div>
							<span class="serailClass"></span>
						</div>
					</div>
				</div>
			
				<div class="fl ml25">
					<!-- Error description textarea field of report-->
					<div class="form-subscribe-header formLabelTxt">
						<label for="name"><?php echo $this->__('Error description');?><span></span></label>
					</div>
					<div class="input-box">
						<textarea class="reasonTextarea" name="error_description[]" id="error_description" title="Error description"><?php echo $_description_collection->getDescriptions();?></textarea>
					</div>
				</div>
				
				<!-- remove icon start here -->
				<div class="fl mt20 minWidth55">
					<?php if($i!=1) :?>
						<div class="btn-remove btn-remove2 mr30 cursor" title="Remove" onclick="removeSerialField(<?php echo $i;?>)"></div>
					<?php endif;?>
				</div>
				<!-- remove icon end here -->
			</div>
			<div class="clear"></div>
		<?php 
		$i++;
		endforeach;?>
		<div class="reasonDescDiv width608px">
		</div>
		<div class="clear"></div>	
			<!-- Set hidden value of rma item id -->
			<input name="rma_item_id" value="<?php echo $_rma_data->getItem_id();?>" type="hidden">
			<!-- Set hidden value of product id -->
			<input name="product_id" value="<?php echo $_rma_data->getProduct_id();?>" type="hidden">
			<!-- Set hidden value of sku number -->
			<input name="sku_number" value="<?php echo $_rma_data->getSku_number();?>" type="hidden">
			<!-- Set hidden value of rma id -->
			<input name="rma_id" value="<?php echo $_rma_data->getRma_id();?>" type="hidden">
			
			<!-- Div start here of submit button -->
			<div class="actions">
				<span class="fl">
				<button type="submit" class="button">
					<p class="required"><?php echo $this->__('* Required Fields') ?></p>
					<span><?php echo $this->__('Submit');?></span>
				</button>
				</span>
					
				<span class="fl mt25 ml10">
				<a href="javascript::void(0)" id="resetSetting">Reset Settings</a>
			</span>
			</div>
			
			<!-- Div end here of submit button -->
		</div> 
	</form>
	
</div>
<!-- Div start here for back url -->
<div class="buttons-set">
	<p class="back-link"><a href="<?php echo $this->getRmaBackUrl() ?>"><small>&laquo; </small><?php echo $this->getBackTitle() ?></a></p>
</div>

<script type="text/javascript">
	
	//<![CDATA[
        var rmaEditFormDetail = new VarienForm('rma_edit_form');
    //]]>
	
	/**
    * manage reason fields as quantity selection
    */
    jQuery(document).ready(function() {
		jQuery('select[name="quantity"]').change(function() {
			/* get selected sku number value */
			var quantity = jQuery('#quantity').val();
			if(quantity!='') {
				jQuery('.reasonDescDiv').html('');
				
				/* Create html value here */
				var htmlContent = '';
				var quantity_val = jQuery('#product_quantity').val();
				
				if(quantity_val<quantity) {
					quantity = quantity-quantity_val;
					quantity_val = 0;
				} else {
					var remain_count = jQuery('#remain_count').val();
					jQuery('#quantity').val(remain_count);
					alert('For quantity changes remove the added values from listing!');
					return false;
				}
				
				for(i=quantity_val;i<quantity;i++) {
					htmlContent += addReasonRow(i);
				}
				jQuery('.reasonDescDiv').html(htmlContent);
			}
		});
		
		/**
		* Reload on reset form
		*/
		jQuery('#resetSetting').click(function() {
			window.location.href = window.location.href;
		});
		
	});
	
	/**
	* Remove serial number field row
	*/
	function removeSerialField(reasonDivId) {
		jQuery('#reasonDiv'+reasonDivId).remove();
		var quantity = jQuery('#quantity').val();
		var product_quantity = jQuery('#product_quantity').val();
		var remain_count = jQuery('#remain_count').val();
		jQuery('#product_quantity').val(parseInt(product_quantity)-1);
		jQuery('#quantity').val(parseInt(quantity)-1);
		jQuery('#remain_count').val(parseInt(remain_count)-1);
	}
  
</script>

